<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vocab Check</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.4; }
    h1 { margin: 0 0 18px; font-size: 42px; }
    #app { max-width: 820px; }
    .row { display: flex; align-items: center; gap: var(--gap); flex-wrap: wrap; }
    label { display: inline-flex; align-items: center; gap: 8px; }
    input, select, button { font-size: 16px; padding: 8px 10px; }
    input { width: 220px; }
    button { cursor: pointer; }
    #status { margin: 14px 0 0; min-height: 1.4em; }
    .muted { opacity: 0.75; }
    #controls { display: none; margin-top: 18px; }
    #wordList { margin-top: 18px; }
    .word-row { display: grid; grid-template-columns: 180px 1fr; gap: 16px; padding: 10px 12px; border-bottom: 1px solid #eee; }
    .en { font-weight: 800; font-size: 28px; line-height: 1.1; }
    .ko { font-size: 22px; cursor: pointer; user-select: none; }
    .ko.mask { letter-spacing: 2px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .pill { border: 1px solid #ddd; background: #fafafa; border-radius: 10px; }
    .pill:hover { background: #f3f3f3; }
    .danger { color: #b00020; }
    .ok { color: #0a7a20; }
    @media (max-width: 520px) {
      h1 { font-size: 34px; }
      .word-row { grid-template-columns: 1fr; }
      .en { font-size: 26px; }
      .ko { font-size: 20px; }
      input { width: 100%; }
    }
  </style>
</head>

<body>
  <h1>Vocab Check</h1>

  <div id="app">
    <div class="row">
      <label>
        í•™ìƒ ID
        <input id="studentIdInput" placeholder="ì˜ˆ: khh0728" autocomplete="off" />
      </label>
      <button id="loadBtn" class="pill">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span class="muted">Enterë¡œë„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”</span>
    </div>

    <p id="status" class="muted"></p>

    <div id="controls">
      <div class="row">
        <label>
          ì„¸íŠ¸ ì„ íƒ
          <select id="setSelect"></select>
        </label>
      </div>

      <div class="toolbar">
        <button id="showAllBtn" class="pill">ì „ì²´ ë³´ê¸°</button>
        <button id="hideAllBtn" class="pill">ì „ì²´ ê°€ë¦¬ê¸°</button>
        <button id="shuffleBtn" class="pill">ì„ê¸°</button>
      </div>
    </div>

    <div id="wordList"></div>
  </div>

  <script>
    // =========================
    // Config
    // =========================
    const MASK = "â€¢â€¢â€¢â€¢â€¢";
    const STORAGE_KEY_LAST_ID = "vocabCheck:lastStudentId";

    // GitHub Pages(ì„œë¸Œë””ë ‰í† ë¦¬ ë°°í¬)ì—ì„œë„ ê²½ë¡œ ì•ˆì •ì ìœ¼ë¡œ ë§Œë“¤ê¸° ìœ„í•œ base ì²˜ë¦¬
    // ì˜ˆ: https://amatda-team.github.io/vocab-check/  -> /vocab-check/
    const BASE_URL = (location.pathname.endsWith("/") ? location.pathname : location.pathname + "/")
      .replace(/\/index\.html?$/i, "/");

    // =========================
    // DOM
    // =========================
    const input = document.getElementById("studentIdInput");
    const button = document.getElementById("loadBtn");
    const status = document.getElementById("status");

    const controls = document.getElementById("controls");
    const setSelect = document.getElementById("setSelect");
    const wordList = document.getElementById("wordList");

    const showAllBtn = document.getElementById("showAllBtn");
    const hideAllBtn = document.getElementById("hideAllBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");

    // =========================
    // State
    // =========================
    let currentIndex = null;
    let currentWords = [];
    let revealedState = [];

    // =========================
    // Helpers
    // =========================
    function setStatus(text, type = "muted") {
      status.className = type;
      status.textContent = text;
    }

    function normalizeId(raw) {
      return raw.trim().toLowerCase();
    }

    function buildIndexPath(id) {
      const prefix = id.slice(0, 2);
      // index.jsonì€ repo root ê¸°ì¤€ ìƒëŒ€ê²½ë¡œë¡œ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ BASE_URLì„ ë¶™ì—¬ì¤€ë‹¤.
      return `${BASE_URL}data/students/${prefix}/${id}/index.json`;
    }

    function toAbsolutePath(pathFromIndex) {
      // index.jsonì˜ pathëŠ” "data/..." ê°™ì€ repo-root ìƒëŒ€ê²½ë¡œë¼ê³  ê°€ì •
      // BASE_URL ë¶™ì—¬ì„œ ì‹¤ì œ fetch ê°€ëŠ¥í•œ ì ˆëŒ€(ì‚¬ì´íŠ¸ ê¸°ì¤€) URLë¡œ ë³€í™˜
      if (/^https?:\/\//i.test(pathFromIndex)) return pathFromIndex;
      return `${BASE_URL}${pathFromIndex}`.replace(/\/{2,}/g, "/").replace(":/", "://");
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`ë¡œë“œ ì‹¤íŒ¨ (${res.status})`);
      return res.json();
    }

    function renderSetOptions(sets) {
      setSelect.innerHTML = "";
      sets.forEach((set, i) => {
        const opt = document.createElement("option");
        opt.value = set.path;
        opt.textContent = set.label || set.yyMMdd || `set ${i + 1}`;
        setSelect.appendChild(opt);
      });
    }

    function renderWords(words) {
      currentWords = Array.isArray(words) ? words : [];
      revealedState = currentWords.map(() => false);

      wordList.innerHTML = "";

      if (!currentWords.length) {
        wordList.innerHTML = `<p class="danger">ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. (ì„¸íŠ¸ JSONì„ í™•ì¸í•´ ì£¼ì„¸ìš”)</p>`;
        return;
      }

      currentWords.forEach(({ en, ko }, idx) => {
        const row = document.createElement("div");
        row.className = "word-row";

        const enEl = document.createElement("div");
        enEl.className = "en";
        enEl.textContent = en ?? "";

        const koEl = document.createElement("div");
        koEl.className = "ko mask";
        koEl.textContent = MASK;
        koEl.title = "í´ë¦­í•´ì„œ ëœ» ë³´ê¸°/ê°€ë¦¬ê¸°";

        koEl.addEventListener("click", () => {
          revealedState[idx] = !revealedState[idx];
          if (revealedState[idx]) {
            koEl.classList.remove("mask");
            koEl.textContent = ko ?? "";
          } else {
            koEl.classList.add("mask");
            koEl.textContent = MASK;
          }
        });

        row.appendChild(enEl);
        row.appendChild(koEl);
        wordList.appendChild(row);
      });
    }

    function applyShowAll(show) {
      const rows = wordList.children;
      for (let i = 0; i < currentWords.length; i++) {
        revealedState[i] = show;
        const koEl = rows[i]?.children?.[1];
        if (!koEl) continue;

        if (show) {
          koEl.classList.remove("mask");
          koEl.textContent = currentWords[i].ko ?? "";
        } else {
          koEl.classList.add("mask");
          koEl.textContent = MASK;
        }
      }
    }

    function shuffleWords() {
      const shuffled = [...currentWords]
        .map(v => ({ v, r: Math.random() }))
        .sort((a, b) => a.r - b.r)
        .map(o => o.v);

      renderWords(shuffled);
      setStatus("ğŸ”€ ë‹¨ì–´ ìˆœì„œë¥¼ ì„ì—ˆì–´ìš”. (ëœ»ì€ ë‹¤ì‹œ ê°€ë ¤ì¡Œì–´ìš”)", "muted");
    }

    // =========================
    // Main flows
    // =========================
    async function loadStudent(studentIdRaw) {
      const id = normalizeId(studentIdRaw);
      if (!id) {
        setStatus("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "danger");
        return;
      }

      // ê¸°ì–µ
      localStorage.setItem(STORAGE_KEY_LAST_ID, id);

      const indexUrl = buildIndexPath(id);

      try {
        setStatus(`ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (${indexUrl.replace(location.origin, "")})`, "muted");

        const idx = await fetchJson(indexUrl);

        if (!idx || !Array.isArray(idx.sets)) {
          throw new Error("index.json í˜•ì‹ ì˜¤ë¥˜ (sets ë°°ì—´ ì—†ìŒ)");
        }
        if (idx.sets.length === 0) {
          throw new Error("ì„¸íŠ¸ê°€ 0ê°œì…ë‹ˆë‹¤. index.jsonì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }

        currentIndex = idx;

        controls.style.display = "block";
        renderSetOptions(currentIndex.sets);

        // ì²« ì„¸íŠ¸ ìë™ ë¡œë“œ
        const firstPath = currentIndex.sets[0].path;
        await loadSetByPath(firstPath);

        setStatus(`âœ… ${id} ì„¸íŠ¸ ${currentIndex.sets.length}ê°œ ë¡œë“œë¨`, "ok");
      } catch (err) {
        console.error(err);
        controls.style.display = "none";
        wordList.innerHTML = "";
        setStatus(`âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, "danger");
      }
    }

    async function loadSetByPath(pathFromIndex) {
      try {
        const setUrl = toAbsolutePath(pathFromIndex);
        const words = await fetchJson(setUrl);

        if (!Array.isArray(words)) {
          throw new Error("ì„¸íŠ¸ JSON í˜•ì‹ ì˜¤ë¥˜ (ë°°ì—´ì´ ì•„ë‹˜)");
        }

        // ê¸°ë³¸ì ì¸ í•„ë“œ ì²´í¬(ë„ˆë¬´ ë¹¡ì„¸ê²ŒëŠ” ì•ˆ í•¨)
        renderWords(words);

      } catch (err) {
        console.error(err);
        wordList.innerHTML = "";
        setStatus(`âŒ ì„¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, "danger");
      }
    }

    // =========================
    // Events
    // =========================
    button.addEventListener("click", () => loadStudent(input.value));

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadStudent(input.value);
    });

    setSelect.addEventListener("change", async () => {
      const path = setSelect.value;
      await loadSetByPath(path);
      setStatus("âœ… ì„¸íŠ¸ë¥¼ ë³€ê²½í–ˆì–´ìš”.", "ok");
    });

    showAllBtn.addEventListener("click", () => {
      applyShowAll(true);
      setStatus("ğŸ‘€ ì „ì²´ ëœ»ì„ í‘œì‹œí–ˆì–´ìš”.", "muted");
    });

    hideAllBtn.addEventListener("click", () => {
      applyShowAll(false);
      setStatus("ğŸ™ˆ ì „ì²´ ëœ»ì„ ë‹¤ì‹œ ê°€ë ¸ì–´ìš”.", "muted");
    });

    shuffleBtn.addEventListener("click", () => {
      shuffleWords();
    });

    // =========================
    // Init: last ID autofill
    // =========================
    (function init() {
      const last = localStorage.getItem(STORAGE_KEY_LAST_ID);
      if (last) {
        input.value = last;
        setStatus(`ì´ì „ ID "${last}"ê°€ ìë™ ì…ë ¥ëì–´ìš”. (ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”)`, "muted");
      } else {
        setStatus("í•™ìƒ IDë¥¼ ì…ë ¥í•˜ê³  ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.", "muted");
      }
    })();
  </script>
</body>
</html>
