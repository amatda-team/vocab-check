<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vocab Check</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; padding: 24px; }
    h1 { margin: 0 0 16px; }
    #app { max-width: 820px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input, select, button { font-size: 16px; padding: 8px 10px; }
    button { cursor: pointer; }
    #status { margin-top: 10px; min-height: 24px; }
    .section { margin-top: 18px; padding-top: 18px; border-top: 1px solid #ddd; }
    .section h2 { margin: 0 0 12px; font-size: 18px; }
    .word-row { display: grid; grid-template-columns: 160px 1fr auto; gap: 12px; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
    .en { font-weight: 700; }
    .ko { user-select: none; }
    .ko.masked { letter-spacing: 2px; }
    .btns { display: inline-flex; gap: 8px; }
    .pill { font-size: 12px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 999px; }
    .muted { color: #666; font-size: 13px; }
    .right { margin-left: auto; }
    .tiny { font-size: 13px; }
  </style>
</head>

<body>
  <h1>Vocab Check</h1>

  <div id="app">
    <div class="row">
      <label>
        학생 ID
        <input id="studentIdInput" placeholder="예: khh0728" />
      </label>

      <button id="loadBtn">불러오기</button>

      <label class="row tiny" style="gap:8px; margin-left: 6px;">
        <input type="checkbox" id="dev10sToggle" />
        개발용 10초 모드
        <span class="pill">추천</span>
      </label>
    </div>

    <p id="status"></p>

    <!-- 오늘의 단어 -->
    <div id="todaySection" class="section" style="display:none;">
      <div class="row">
        <h2 style="margin:0;">오늘의 단어</h2>
        <span id="todayHint" class="muted"></span>
        <button id="refreshDueBtn" class="right">새로고침</button>
      </div>
      <div id="todayList" style="margin-top:10px;"></div>
      <p class="muted" style="margin-top:10px;">
        * ‘몰라요’로 제출한 단어가 (운영) 3일 후 / (개발 10초 모드) 10초 후에 여기로 올라옵니다.
      </p>
    </div>

    <!-- 세트 선택 -->
    <div id="controls" class="section" style="display:none;">
      <div class="row">
        <h2 style="margin:0;">세트 보기</h2>
        <label class="right">
          세트 선택
          <select id="setSelect"></select>
        </label>
      </div>
      <div id="wordList" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    // ✅ 너의 Worker URL
    const API_BASE = "https://vocab-check-api.amatda-team.workers.dev";

    const input = document.getElementById("studentIdInput");
    const button = document.getElementById("loadBtn");
    const status = document.getElementById("status");

    const controls = document.getElementById("controls");
    const setSelect = document.getElementById("setSelect");
    const wordList = document.getElementById("wordList");

    const todaySection = document.getElementById("todaySection");
    const todayList = document.getElementById("todayList");
    const todayHint = document.getElementById("todayHint");
    const refreshDueBtn = document.getElementById("refreshDueBtn");

    const dev10sToggle = document.getElementById("dev10sToggle");

    // 토글 상태 유지
    dev10sToggle.checked = localStorage.getItem("DEV_10S") === "1";
    dev10sToggle.addEventListener("change", () => {
      localStorage.setItem("DEV_10S", dev10sToggle.checked ? "1" : "0");
      // due 재조회
      if (window.__currentStudentId) refreshDue();
    });

    function withDebug(url){
      const isDev10s = localStorage.getItem("DEV_10S") === "1";
      return isDev10s ? `${url}${url.includes("?") ? "&" : "?"}debug=1` : url;
    }

    let currentIndex = null;

    async function loadStudentIndex(studentIdRaw) {
      const id = studentIdRaw.trim().toLowerCase();
      const prefix = id.slice(0, 2);
      const indexPath = `data/students/${prefix}/${id}/index.json`;

      status.textContent = `불러오는 중... (${indexPath})`;

      const res = await fetch(indexPath, { cache: "no-store" });
      if (!res.ok) throw new Error(`index.json 로드 실패: ${res.status}`);

      const data = await res.json();
      if (!Array.isArray(data.sets)) throw new Error("index.json 형식 오류");

      return { id, data };
    }

    async function loadSet(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`세트 로드 실패: ${res.status}`);
      return res.json();
    }

    async function postEvent({ studentId, setId, word, meaning, result }) {
      const res = await fetch(withDebug(`${API_BASE}/event`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ studentId, setId, word, meaning, result }),
      });
      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out.ok) throw new Error(out.error || "event 실패");
      return out;
    }

    async function fetchDue(studentId, limit = 20) {
      const res = await fetch(withDebug(`${API_BASE}/due?studentId=${encodeURIComponent(studentId)}&limit=${limit}`), {
        cache: "no-store",
      });
      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out.ok) throw new Error(out.error || "due 실패");
      return out.items || [];
    }

    function renderSetOptions(sets) {
      setSelect.innerHTML = "";
      sets.forEach((set) => {
        const opt = document.createElement("option");
        opt.value = set.path;
        // label 우선, 없으면 yyMMdd
        opt.textContent = set.label || set.date || set.yyMMdd || set.path;
        opt.dataset.yymd = set.yyMMdd || "";
        setSelect.appendChild(opt);
      });
    }

    function makeWordRow({ en, ko }, { studentId, setId }, afterSubmit) {
      const row = document.createElement("div");
      row.className = "word-row";

      const enEl = document.createElement("div");
      enEl.className = "en";
      enEl.textContent = en;

      const koEl = document.createElement("div");
      koEl.className = "ko masked";
      koEl.textContent = "•••••";

      const btns = document.createElement("div");
      btns.className = "btns";

      const knowBtn = document.createElement("button");
      knowBtn.textContent = "알아요";

      const dontBtn = document.createElement("button");
      dontBtn.textContent = "몰라요";

      const setReveal = () => {
        koEl.textContent = ko || "";
        koEl.classList.remove("masked");
      };

      const lock = () => {
        knowBtn.disabled = true;
        dontBtn.disabled = true;
      };

      knowBtn.addEventListener("click", async () => {
        try {
          lock();
          setReveal();
          await postEvent({ studentId, setId, word: en, meaning: ko, result: "know" });
          if (afterSubmit) afterSubmit();
        } catch (e) {
          alert("제출 실패: " + e.message);
          knowBtn.disabled = false;
          dontBtn.disabled = false;
        }
      });

      dontBtn.addEventListener("click", async () => {
        try {
          lock();
          setReveal();
          await postEvent({ studentId, setId, word: en, meaning: ko, result: "dontknow" });
          if (afterSubmit) afterSubmit();
        } catch (e) {
          alert("제출 실패: " + e.message);
          knowBtn.disabled = false;
          dontBtn.disabled = false;
        }
      });

      btns.appendChild(knowBtn);
      btns.appendChild(dontBtn);

      row.appendChild(enEl);
      row.appendChild(koEl);
      row.appendChild(btns);

      return row;
    }

    function renderWords(words, ctx) {
      wordList.innerHTML = "";

      words.forEach((w) => {
        const row = makeWordRow(
          { en: w.en, ko: w.ko },
          ctx,
          () => {
            // 세트에서 눌러도 오늘의 단어에 영향 있을 수 있으니 갱신
            refreshDue();
          }
        );
        wordList.appendChild(row);
      });
    }

    function renderDueItems(items, ctx) {
      todayList.innerHTML = "";

      if (!items.length) {
        todayList.innerHTML = `<p class="muted">오늘 복습할 단어가 아직 없어요.</p>`;
        return;
      }

      items.forEach((it) => {
        // due는 meaning을 서버에 저장해둔 값 사용
        const row = document.createElement("div");
        row.className = "word-row";

        const enEl = document.createElement("div");
        enEl.className = "en";
        enEl.textContent = it.word;

        const koEl = document.createElement("div");
        koEl.className = "ko masked";
        koEl.textContent = "•••••";

        const btns = document.createElement("div");
        btns.className = "btns";

        const knowBtn = document.createElement("button");
        knowBtn.textContent = "알아요";

        const dontBtn = document.createElement("button");
        dontBtn.textContent = "몰라요";

        const reveal = () => {
          koEl.textContent = it.meaning || "";
          koEl.classList.remove("masked");
        };

        const lock = () => {
          knowBtn.disabled = true;
          dontBtn.disabled = true;
        };

        knowBtn.addEventListener("click", async () => {
          try {
            lock();
            reveal();
            await postEvent({ studentId: ctx.studentId, setId: ctx.setId, word: it.word, meaning: it.meaning, result: "know" });
            refreshDue();
          } catch (e) {
            alert("제출 실패: " + e.message);
            knowBtn.disabled = false;
            dontBtn.disabled = false;
          }
        });

        dontBtn.addEventListener("click", async () => {
          try {
            lock();
            reveal();
            await postEvent({ studentId: ctx.studentId, setId: ctx.setId, word: it.word, meaning: it.meaning, result: "dontknow" });
            refreshDue();
          } catch (e) {
            alert("제출 실패: " + e.message);
            knowBtn.disabled = false;
            dontBtn.disabled = false;
          }
        });

        btns.appendChild(knowBtn);
        btns.appendChild(dontBtn);

        row.appendChild(enEl);
        row.appendChild(koEl);
        row.appendChild(btns);

        todayList.appendChild(row);
      });
    }

    async function refreshDue() {
      const studentId = window.__currentStudentId;
      if (!studentId) return;

      try {
        const items = await fetchDue(studentId, 30);
        todaySection.style.display = "block";
        todayHint.textContent = `(${items.length}개)`;
        renderDueItems(items, {
          studentId,
          setId: window.__currentSetId || "",
        });
      } catch (e) {
        todaySection.style.display = "block";
        todayHint.textContent = "";
        todayList.innerHTML = `<p class="muted">due 불러오기 실패: ${e.message}</p>`;
      }
    }

    refreshDueBtn.addEventListener("click", () => refreshDue());

    async function loadFlow() {
      const raw = input.value;
      if (!raw.trim()) {
        status.textContent = "ID를 입력하세요.";
        return;
      }

      try {
        const { id, data } = await loadStudentIndex(raw);
        window.__currentStudentId = id;
        currentIndex = data;

        status.textContent = `✅ 세트 ${currentIndex.sets.length}개 로드됨`;
        controls.style.display = "block";

        renderSetOptions(currentIndex.sets);

        // 첫 세트 자동 로드
        const first = currentIndex.sets[0];
        const firstPath = first.path;
        window.__currentSetId = first.yyMMdd || "";
        const words = await loadSet(firstPath);
        renderWords(words, { studentId: id, setId: window.__currentSetId });

        // due(오늘의 단어) 로드
        await refreshDue();

      } catch (err) {
        console.error(err);
        status.textContent = `❌ 실패: ${err.message}`;
      }
    }

    button.addEventListener("click", loadFlow);

    // ✅ Enter로 로드
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadFlow();
    });

    setSelect.addEventListener("change", async () => {
      try {
        const path = setSelect.value;

        // 현재 선택된 option의 yyMMdd를 setId로 보관
        const opt = setSelect.options[setSelect.selectedIndex];
        window.__currentSetId = opt?.dataset?.yymd || "";

        const words = await loadSet(path);
        renderWords(words, { studentId: window.__currentStudentId, setId: window.__currentSetId });

      } catch (err) {
        console.error(err);
        status.textContent = `❌ 세트 변경 실패`;
      }
    });
  </script>
</body>
</html>
