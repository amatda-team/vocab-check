<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vocab Check</title>
  <style>
    :root{
      --bd:#e5e7eb;
      --bd2:#f1f5f9;
      --txt:#111827;
      --muted:#6b7280;
      --bg:#ffffff;
      --ok:#16a34a;
      --bad:#dc2626;
      --ink:#111827;
      --soft:#f8fafc;
    }

    *{ box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif;
      padding: 24px;
      color:var(--txt);
      background:var(--bg);
      margin:0;
    }
    h1 { margin: 0 0 16px; font-size:44px; letter-spacing:-0.6px; }
    #app { max-width: 860px; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label{ display:flex; gap:8px; align-items:center; }
    input, select, button { font-size:16px; padding:10px 12px; }
    input, select { border:1px solid var(--bd); border-radius:12px; background:#fff; }
    input{ width:240px; }
    button { cursor:pointer; border:1px solid var(--bd); border-radius:12px; background:#fff; font-weight:800; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    #status { margin-top: 10px; min-height: 24px; color:var(--muted); font-weight:700; }
    .section { margin-top:18px; padding-top:18px; border-top:1px solid var(--bd); }
    .section h2 { margin:0 0 12px; font-size:20px; letter-spacing:-0.2px; }
    .pill { font-size:12px; padding:4px 8px; border:1px solid var(--bd); border-radius:999px; }
    .muted { color:var(--muted); font-size:13px; }
    .right { margin-left:auto; }
    .tiny { font-size:13px; }

    .toast{
      margin-top:10px;
      padding:12px 14px;
      border:1px solid var(--bd);
      border-radius:14px;
      background: var(--soft);
      font-weight:900;
      display:none;
    }
    .toast.show{ display:block; }

    /* ===== Buttons ===== */
    .primary{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .ghost{
      background:#fff;
      color:#111827;
    }

    /* ===== 공통 리스트(세트/오늘의 단어 공통) ===== */
    .word-row{
      display:grid;
      grid-template-columns: 170px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px 0;
      border-bottom:1px dashed var(--bd2);
    }
    .en{ font-weight:900; letter-spacing:.2px; }
    .ko{ user-select:none; line-height:1.25; }
    .ko.masked{ letter-spacing:2px; color: var(--muted); }
    .btns{ display:inline-flex; gap:8px; }
    .btnChoice{
      padding:10px 12px;
      min-width:88px;
      border-radius:12px;
      font-weight:900;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      border:1px solid var(--bd);
      background:#fff;
    }
    .btnChoice:active{ transform:scale(.98); }
    .btnChoice.know.selected{ background:rgba(22,163,74,.12); border-color:rgba(22,163,74,.35); color:var(--ok); }
    .btnChoice.dont.selected{ background:rgba(220,38,38,.10); border-color:rgba(220,38,38,.35); color:var(--bad); }
    .rowSelected{
      background: linear-gradient(90deg, rgba(0,0,0,.02), rgba(0,0,0,0));
      border-radius:12px;
      padding-left:8px;
      padding-right:8px;
    }

    .due-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin-top:12px;
      flex-wrap:wrap;
    }

    /* ===== 모바일 반응형 ===== */
    @media (max-width: 520px){
      body{ padding:16px; }
      h1{ font-size:40px; }
      #app{ max-width:100%; }

      input{ width: 100%; max-width: 320px; }
      .row{ gap:10px; }
      .right{ margin-left:0; }

      /* 세트/오늘 공통 리스트: 2줄 배치 */
      .word-row{
        grid-template-columns: 1fr auto;
        grid-template-areas:
          "en btns"
          "ko btns";
        gap:10px;
        padding:14px 0;
      }
      .word-row .en{ grid-area: en; }
      .word-row .ko{ grid-area: ko; }
      .word-row .btns{ grid-area: btns; align-self:start; }
      .btnChoice{ min-width:74px; padding:10px 10px; }
    }
  </style>
</head>

<body>
  <h1>Vocab Check</h1>

  <div id="app">
    <div class="row">
      <label>
        학생 ID
        <input id="studentIdInput" placeholder="예: khh0728" autocomplete="off" />
      </label>

      <button id="loadBtn" class="primary">불러오기</button>

      <label class="row tiny" style="gap:8px; margin-left: 6px;">
        <input type="checkbox" id="dev10sToggle" />
        개발용 10초 모드
        <span class="pill">추천</span>
      </label>
    </div>

    <p id="status"></p>
    <div id="toast" class="toast"></div>

    <!-- 오늘의 단어 -->
    <div id="todaySection" class="section" style="display:none;">
      <div class="row">
        <h2 style="margin:0;">오늘의 단어</h2>
        <span id="todayHint" class="muted"></span>
        <button id="refreshDueBtn" class="right ghost">새로고침</button>
      </div>

      <div id="todayList" style="margin-top:10px;"></div>

      <div class="due-actions">
        <button id="dueResetBtn" class="ghost">선택 초기화</button>
        <button id="dueSubmitBtn" class="primary">완료</button>
      </div>

      <p class="muted" style="margin-top:10px;">
        * ‘몰라요’로 제출한 단어가 (운영) 3일 후 / (개발 10초 모드) 10초 후에 여기로 올라옵니다.
      </p>
    </div>

    <!-- 세트 선택 -->
    <div id="controls" class="section" style="display:none;">
      <div class="row">
        <h2 style="margin:0;">세트 보기</h2>
        <label class="right">
          세트 선택
          <select id="setSelect"></select>
        </label>
      </div>

      <div id="wordList" style="margin-top:10px;"></div>

      <div class="due-actions">
        <button id="setResetBtn" class="ghost">선택 초기화</button>
        <button id="setSubmitBtn" class="primary">완료</button>
      </div>
    </div>
  </div>

  <script>
    // ✅ Worker URL
    const API_BASE = "https://vocab-check-api.amatda-team.workers.dev";

    const input = document.getElementById("studentIdInput");
    const button = document.getElementById("loadBtn");
    const status = document.getElementById("status");
    const toast = document.getElementById("toast");

    const controls = document.getElementById("controls");
    const setSelect = document.getElementById("setSelect");
    const wordList = document.getElementById("wordList");

    const todaySection = document.getElementById("todaySection");
    const todayList = document.getElementById("todayList");
    const todayHint = document.getElementById("todayHint");
    const refreshDueBtn = document.getElementById("refreshDueBtn");
    const dueSubmitBtn = document.getElementById("dueSubmitBtn");
    const dueResetBtn = document.getElementById("dueResetBtn");

    const setSubmitBtn = document.getElementById("setSubmitBtn");
    const setResetBtn = document.getElementById("setResetBtn");

    const dev10sToggle = document.getElementById("dev10sToggle");

    // ===== LocalStorage keys =====
    const LS_LAST_ID = "VOCAB_LAST_STUDENT_ID";
    const LS_DEV10S = "DEV_10S";

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1800);
    }

    function withDebug(url){
      const isDev10s = localStorage.getItem(LS_DEV10S) === "1";
      return isDev10s ? `${url}${url.includes("?") ? "&" : "?"}debug=1` : url;
    }

    // 토글 상태 유지
    dev10sToggle.checked = localStorage.getItem(LS_DEV10S) === "1";
    dev10sToggle.addEventListener("change", () => {
      localStorage.setItem(LS_DEV10S, dev10sToggle.checked ? "1" : "0");
      if (window.__currentStudentId) refreshDue();
    });

    // 최근 입력 ID 자동 세팅 + 자동 로드
    const last = (localStorage.getItem(LS_LAST_ID) || "").trim();
    if (last) input.value = last;

    let currentIndex = null;

    // ===== batch states =====
    // 오늘의 단어: word -> { result: "know"|"dontknow"|null, meaning }
    const dueState = new Map();
    // 세트: key = en, value = { result, meaning }
    const setState = new Map();

    async function loadStudentIndex(studentIdRaw) {
      const id = studentIdRaw.trim().toLowerCase();
      const prefix = id.slice(0, 2);
      const indexPath = `data/students/${prefix}/${id}/index.json`;

      status.textContent = `불러오는 중... (${indexPath})`;

      const res = await fetch(indexPath, { cache: "no-store" });
      if (!res.ok) throw new Error(`index.json 로드 실패: ${res.status}`);

      const data = await res.json();
      if (!Array.isArray(data.sets)) throw new Error("index.json 형식 오류");

      return { id, data };
    }

    async function loadSet(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`세트 로드 실패: ${res.status}`);
      return res.json();
    }

    async function postEvent({ studentId, setId, word, meaning, result }) {
      const res = await fetch(withDebug(`${API_BASE}/event`), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ studentId, setId, word, meaning, result }),
      });
      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out.ok) throw new Error(out.error || "event 실패");
      return out;
    }

    async function fetchDue(studentId, limit = 20) {
      const res = await fetch(withDebug(`${API_BASE}/due?studentId=${encodeURIComponent(studentId)}&limit=${limit}`), {
        cache: "no-store",
      });
      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out.ok) throw new Error(out.error || "due 실패");
      return out.items || [];
    }

    function renderSetOptions(sets) {
      setSelect.innerHTML = "";
      sets.forEach((set) => {
        const opt = document.createElement("option");
        opt.value = set.path;
        opt.textContent = set.label || set.date || set.yyMMdd || set.path;
        opt.dataset.yymd = set.yyMMdd || "";
        setSelect.appendChild(opt);
      });
    }

    // ====== 오늘의 단어: (세트와 동일한 버튼 UI) ======
    function createDueRow(item, ctx){
      const row = document.createElement("div");
      row.className = "word-row";

      const enEl = document.createElement("div");
      enEl.className = "en";
      enEl.textContent = item.word;

      const koEl = document.createElement("div");
      koEl.className = "ko masked";
      koEl.textContent = "•••••";

      const btns = document.createElement("div");
      btns.className = "btns";

      const knowBtn = document.createElement("button");
      knowBtn.className = "btnChoice know";
      knowBtn.textContent = "알아요";

      const dontBtn = document.createElement("button");
      dontBtn.className = "btnChoice dont";
      dontBtn.textContent = "몰라요";

      const reveal = () => {
        koEl.textContent = item.meaning || "";
        koEl.classList.remove("masked");
      };

      const applySelected = (result) => {
        if(result){
          row.classList.add("rowSelected");
          reveal();
        }else{
          row.classList.remove("rowSelected");
          koEl.textContent = "•••••";
          koEl.classList.add("masked");
        }
        knowBtn.classList.toggle("selected", result === "know");
        dontBtn.classList.toggle("selected", result === "dontknow");
      };

      // 초기 state 반영
      if(!dueState.has(item.word)){
        dueState.set(item.word, { result: null, meaning: item.meaning || "" });
      }
      applySelected(dueState.get(item.word).result);

      knowBtn.addEventListener("click", () => {
        dueState.set(item.word, { result: "know", meaning: item.meaning || "" });
        applySelected("know");
      });

      dontBtn.addEventListener("click", () => {
        dueState.set(item.word, { result: "dontknow", meaning: item.meaning || "" });
        applySelected("dontknow");
      });

      btns.appendChild(knowBtn);
      btns.appendChild(dontBtn);

      row.appendChild(enEl);
      row.appendChild(koEl);
      row.appendChild(btns);

      return row;
    }

    function renderDueItems(items, ctx) {
      todayList.innerHTML = "";
      dueState.clear();

      if (!items.length) {
        todayList.innerHTML = `<p class="muted">오늘 복습할 단어가 아직 없어요.</p>`;
        return;
      }

      items.forEach((it) => {
        todayList.appendChild(createDueRow(it, ctx));
      });
    }

    async function refreshDue() {
      const studentId = window.__currentStudentId;
      if (!studentId) return;

      try {
        const items = await fetchDue(studentId, 30);
        todaySection.style.display = "block";
        todayHint.textContent = `(${items.length}개)`;
        renderDueItems(items, { studentId, setId: window.__currentSetId || "" });
      } catch (e) {
        todaySection.style.display = "block";
        todayHint.textContent = "";
        todayList.innerHTML = `<p class="muted">due 불러오기 실패: ${e.message}</p>`;
      }
    }

    refreshDueBtn.addEventListener("click", () => refreshDue());

    dueResetBtn.addEventListener("click", () => {
      // 선택 초기화는 "다시 렌더"가 제일 확실
      refreshDue();
      showToast("선택을 초기화했어요.");
    });

    // ✅ 오늘의 단어: 미선택 있으면 완료 불가 + alert
    dueSubmitBtn.addEventListener("click", async () => {
      const studentId = window.__currentStudentId;
      if(!studentId) return;

      if (dueState.size === 0) {
        alert("오늘의 단어가 없어요.");
        return;
      }

      const hasUnselected = Array.from(dueState.values()).some(v => v.result == null);
      if (hasUnselected) {
        alert("아직 선택하지 않은 단어가 있어요.\n각 단어를 ‘몰라요/알아요’ 버튼으로 선택해 주세요.");
        return;
      }

      const entries = Array.from(dueState.entries())
        .filter(([w, v]) => v.result === "know" || v.result === "dontknow");

      if(entries.length === 0){
        alert("선택된 단어가 없어요.");
        return;
      }

      dueSubmitBtn.disabled = true;

      try{
        for(const [word, v] of entries){
          await postEvent({
            studentId,
            setId: window.__currentSetId || "",
            word,
            meaning: v.meaning || "",
            result: v.result
          });
        }
        showToast("오늘의 단어 학습 끝!");
        await refreshDue(); // ✅ 갱신 1회
      }catch(e){
        alert("제출 실패: " + e.message);
      }finally{
        dueSubmitBtn.disabled = false;
      }
    });

    // ====== 세트 리스트 (버튼 + 배치 제출) ======
    function makeSetWordRow(w, ctx){
      const row = document.createElement("div");
      row.className = "word-row";

      const enEl = document.createElement("div");
      enEl.className = "en";
      enEl.textContent = w.en;

      const koEl = document.createElement("div");
      koEl.className = "ko masked";
      koEl.textContent = "•••••";

      const btns = document.createElement("div");
      btns.className = "btns";

      const knowBtn = document.createElement("button");
      knowBtn.className = "btnChoice know";
      knowBtn.textContent = "알아요";

      const dontBtn = document.createElement("button");
      dontBtn.className = "btnChoice dont";
      dontBtn.textContent = "몰라요";

      const reveal = () => {
        koEl.textContent = w.ko || "";
        koEl.classList.remove("masked");
      };

      const applySelected = (result) => {
        if(result){
          row.classList.add("rowSelected");
          reveal();
        }else{
          row.classList.remove("rowSelected");
          koEl.textContent = "•••••";
          koEl.classList.add("masked");
        }
        knowBtn.classList.toggle("selected", result === "know");
        dontBtn.classList.toggle("selected", result === "dontknow");
      };

      const key = w.en;
      if(!setState.has(key)){
        setState.set(key, { result: null, meaning: w.ko || "" });
      }
      applySelected(setState.get(key).result);

      knowBtn.addEventListener("click", () => {
        setState.set(key, { result: "know", meaning: w.ko || "" });
        applySelected("know");
      });

      dontBtn.addEventListener("click", () => {
        setState.set(key, { result: "dontknow", meaning: w.ko || "" });
        applySelected("dontknow");
      });

      btns.appendChild(knowBtn);
      btns.appendChild(dontBtn);

      row.appendChild(enEl);
      row.appendChild(koEl);
      row.appendChild(btns);

      return row;
    }

    function renderWords(words, ctx) {
      wordList.innerHTML = "";
      setState.clear();
      words.forEach((w) => wordList.appendChild(makeSetWordRow(w, ctx)));
    }

    setResetBtn.addEventListener("click", async () => {
      try{
        const path = setSelect.value;
        const words = await loadSet(path);
        renderWords(words, { studentId: window.__currentStudentId, setId: window.__currentSetId });
        showToast("세트 선택을 초기화했어요.");
      }catch(e){
        showToast("초기화 실패");
      }
    });

    setSubmitBtn.addEventListener("click", async () => {
      const studentId = window.__currentStudentId;
      if(!studentId) return;

      const entries = Array.from(setState.entries())
        .filter(([en, v]) => v.result === "know" || v.result === "dontknow");

      if(entries.length === 0){
        alert("아직 선택한 단어가 없어요.");
        return;
      }

      setSubmitBtn.disabled = true;

      try{
        for(const [word, v] of entries){
          await postEvent({
            studentId,
            setId: window.__currentSetId || "",
            word,
            meaning: v.meaning || "",
            result: v.result
          });
        }
        showToast("세트 학습 완료!");
        await refreshDue(); // ✅ due 갱신 1회
      }catch(e){
        alert("제출 실패: " + e.message);
      }finally{
        setSubmitBtn.disabled = false;
      }
    });

    // ====== 로드 플로우 ======
    async function loadFlow(auto=false) {
      const raw = input.value;
      if (!raw.trim()) {
        status.textContent = "ID를 입력하세요.";
        return;
      }

      try {
        localStorage.setItem(LS_LAST_ID, raw.trim());

        const { id, data } = await loadStudentIndex(raw);
        window.__currentStudentId = id;
        currentIndex = data;

        status.textContent = `✅ 세트 ${currentIndex.sets.length}개 로드됨`;
        controls.style.display = "block";

        renderSetOptions(currentIndex.sets);

        const first = currentIndex.sets[0];
        window.__currentSetId = first.yyMMdd || "";
        const words = await loadSet(first.path);
        renderWords(words, { studentId: id, setId: window.__currentSetId });

        await refreshDue();

        if(auto) showToast("최근 학생 ID로 자동 로드했어요.");
      } catch (err) {
        console.error(err);
        status.textContent = `❌ 실패: ${err.message}`;
      }
    }

    button.addEventListener("click", () => loadFlow(false));
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadFlow(false);
    });

    setSelect.addEventListener("change", async () => {
      try {
        const path = setSelect.value;
        const opt = setSelect.options[setSelect.selectedIndex];
        window.__currentSetId = opt?.dataset?.yymd || "";

        const words = await loadSet(path);
        renderWords(words, { studentId: window.__currentStudentId, setId: window.__currentSetId });
        showToast("세트를 바꿨어요.");
      } catch (err) {
        console.error(err);
        status.textContent = `❌ 세트 변경 실패: ${err.message || ""}`;
      }
    });

    // ✅ 페이지 열자마자 최근 ID가 있으면 자동 로드
    if(last){
      setTimeout(()=>loadFlow(true), 30);
    }
  </script>
</body>
</html>
