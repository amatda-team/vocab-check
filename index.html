<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vocab Check</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.4; }
    h1 { margin: 0 0 18px; font-size: 42px; }
    #app { max-width: 980px; }
    .row { display: flex; align-items: center; gap: var(--gap); flex-wrap: wrap; }
    label { display: inline-flex; align-items: center; gap: 8px; }
    input, select, button { font-size: 16px; padding: 8px 10px; }
    input { width: 220px; }
    button { cursor: pointer; }
    #status { margin: 14px 0 0; min-height: 1.4em; }
    .muted { opacity: 0.75; }
    #controls { display: none; margin-top: 18px; }
    #wordList { margin-top: 18px; }
    .word-row {
      display: grid;
      grid-template-columns: 200px 1fr auto;
      gap: 16px;
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      align-items: center;
    }
    .en { font-weight: 800; font-size: 28px; line-height: 1.1; }
    .ko { font-size: 20px; user-select: none; }
    .ko.mask { letter-spacing: 2px; }
    .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
    .pill { border: 1px solid #ddd; background: #fafafa; border-radius: 10px; }
    .pill:hover { background: #f3f3f3; }
    .danger { color: #b00020; }
    .ok { color: #0a7a20; }
    .btn-know, .btn-dk {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      min-width: 72px;
    }
    .btn-know.active { border-color: #0a7a20; background: rgba(10,122,32,0.08); }
    .btn-dk.active { border-color: #b00020; background: rgba(176,0,32,0.08); }
    .summary { margin-top: 12px; }
    .summary b { font-weight: 800; }
    @media (max-width: 720px) {
      h1 { font-size: 34px; }
      .word-row { grid-template-columns: 1fr; align-items: start; }
      .actions { justify-content: flex-start; }
      .en { font-size: 26px; }
      input { width: 100%; }
    }
  </style>
</head>

<body>
  <h1>Vocab Check</h1>

  <div id="app">
    <div class="row">
      <label>
        í•™ìƒ ID
        <input id="studentIdInput" placeholder="ì˜ˆ: khh0728" autocomplete="off" />
      </label>
      <button id="loadBtn" class="pill">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span class="muted">Enterë¡œë„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”</span>
    </div>

    <p id="status" class="muted"></p>

    <div id="controls">
      <div class="row">
        <label>
          ì„¸íŠ¸ ì„ íƒ
          <select id="setSelect"></select>
        </label>
      </div>

      <div class="toolbar">
        <button id="showAllBtn" class="pill">ì „ì²´ ë³´ê¸°</button>
        <button id="hideAllBtn" class="pill">ì „ì²´ ê°€ë¦¬ê¸°</button>
        <button id="shuffleBtn" class="pill">ì„ê¸°</button>

        <span class="muted">|</span>

        <button id="sendBtn" class="pill">ê²°ê³¼ ë³´ë‚´ê¸°</button>
        <span id="sendHint" class="muted"></span>
      </div>

      <div class="summary muted" id="summary"></div>
    </div>

    <div id="wordList"></div>
  </div>

  <!-- Tally embed script (popup/openPopup í•„ìš”) -->
  <script src="https://tally.so/widgets/embed.js"></script>

  <script>
    // =========================
    // Config
    // =========================
    const MASK = "â€¢â€¢â€¢â€¢â€¢";
    const STORAGE_KEY_LAST_ID = "vocabCheck:lastStudentId";

    // âœ… ë„ˆì˜ Tally í¼ ID
    const TALLY_FORM_ID = "GxpL72";

    // âœ… Tally hidden field key (ë„ˆê°€ ë§Œë“¤ì–´ë‘” ì´ë¦„ê³¼ ì •í™•íˆ ê°™ì•„ì•¼ í•¨)
    const TALLY_FIELDS = {
      studentId: "studentId",
      setId: "setId",
      setLabel: "setLabel",
      knownCount: "knownCount",
      unknownCount: "unknownCount",
      totalCount: "totalCount",
      unknownWords: "unknownWords",
      pageUrl: "pageUrl",
      submittedAt: "submittedAt"
    };

    // GitHub Pages(ì„œë¸Œë””ë ‰í† ë¦¬ ë°°í¬)ì—ì„œë„ ê²½ë¡œ ì•ˆì •ì ìœ¼ë¡œ ë§Œë“¤ê¸° ìœ„í•œ base ì²˜ë¦¬
    const BASE_URL = (location.pathname.endsWith("/") ? location.pathname : location.pathname + "/")
      .replace(/\/index\.html?$/i, "/");

    // =========================
    // DOM
    // =========================
    const input = document.getElementById("studentIdInput");
    const button = document.getElementById("loadBtn");
    const status = document.getElementById("status");

    const controls = document.getElementById("controls");
    const setSelect = document.getElementById("setSelect");
    const wordList = document.getElementById("wordList");

    const showAllBtn = document.getElementById("showAllBtn");
    const hideAllBtn = document.getElementById("hideAllBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");

    const sendBtn = document.getElementById("sendBtn");
    const sendHint = document.getElementById("sendHint");
    const summaryEl = document.getElementById("summary");

    // =========================
    // State
    // =========================
    let currentIndex = null;
    let currentWords = [];
    let revealedState = []; // ëœ» ë§ˆìŠ¤í‚¹ ìƒíƒœ
    // knowState: null | "known" | "unknown"
    let knowState = [];

    // í˜„ì¬ ì„¸íŠ¸ ë©”íƒ€
    let currentStudentId = "";
    let currentSetId = "";
    let currentSetLabel = "";

    // =========================
    // Helpers
    // =========================
    function setStatus(text, type = "muted") {
      status.className = type;
      status.textContent = text;
    }

    function normalizeId(raw) {
      return raw.trim().toLowerCase();
    }

    function buildIndexPath(id) {
      const prefix = id.slice(0, 2);
      return `${BASE_URL}data/students/${prefix}/${id}/index.json`;
    }

    function toAbsolutePath(pathFromIndex) {
      if (/^https?:\/\//i.test(pathFromIndex)) return pathFromIndex;
      return `${BASE_URL}${pathFromIndex}`.replace(/\/{2,}/g, "/").replace(":/", "://");
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`ë¡œë“œ ì‹¤íŒ¨ (${res.status})`);
      return res.json();
    }

    function renderSetOptions(sets) {
      setSelect.innerHTML = "";
      sets.forEach((set, i) => {
        const opt = document.createElement("option");
        opt.value = set.path;
        opt.textContent = set.label || set.yyMMdd || `set ${i + 1}`;
        // label/setId ì •ë³´ë„ ë‹´ì•„ë‘ê¸°
        opt.dataset.setId = set.yyMMdd || "";
        opt.dataset.setLabel = set.label || set.yyMMdd || "";
        setSelect.appendChild(opt);
      });
    }

    function updateSummary() {
      const total = currentWords.length;
      const known = knowState.filter(v => v === "known").length;
      const unknown = knowState.filter(v => v === "unknown").length;
      const undecided = total - known - unknown;

      summaryEl.innerHTML =
        `ì´ <b>${total}</b>ê°œ Â· ì•Œì•„ìš” <b>${known}</b> Â· ëª°ë¼ìš” <b>${unknown}</b> Â· ë¯¸ì„ íƒ <b>${undecided}</b>`;
      sendHint.textContent = undecided > 0 ? "(ì•„ì§ ë¯¸ì„ íƒ ë‹¨ì–´ê°€ ìˆì–´ìš”)" : "(ì „ë¶€ ì„ íƒë¨)";
    }

    function renderWords(words) {
      currentWords = Array.isArray(words) ? words : [];
      revealedState = currentWords.map(() => false);
      knowState = currentWords.map(() => null);

      wordList.innerHTML = "";

      if (!currentWords.length) {
        wordList.innerHTML = `<p class="danger">ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. (ì„¸íŠ¸ JSONì„ í™•ì¸í•´ ì£¼ì„¸ìš”)</p>`;
        updateSummary();
        return;
      }

      currentWords.forEach(({ en, ko }, idx) => {
        const row = document.createElement("div");
        row.className = "word-row";

        const enEl = document.createElement("div");
        enEl.className = "en";
        enEl.textContent = en ?? "";

        const koEl = document.createElement("div");
        koEl.className = "ko mask";
        koEl.textContent = MASK;

        const actions = document.createElement("div");
        actions.className = "actions";

        const knowBtn = document.createElement("button");
        knowBtn.className = "btn-know";
        knowBtn.textContent = "ì•Œì•„ìš”";

        const dkBtn = document.createElement("button");
        dkBtn.className = "btn-dk";
        dkBtn.textContent = "ëª°ë¼ìš”";

        function revealMeaning() {
          revealedState[idx] = true;
          koEl.classList.remove("mask");
          koEl.textContent = ko ?? "";
        }

        function setKnown(value) {
          knowState[idx] = value;

          // ë²„íŠ¼ UI
          knowBtn.classList.toggle("active", value === "known");
          dkBtn.classList.toggle("active", value === "unknown");

          // ê·œì¹™: ë²„íŠ¼(ë‘˜ ì¤‘ ì•„ë¬´ê±°ë‚˜) ëˆ„ë¥´ë©´ ëœ» ì˜¤í”ˆ
          revealMeaning();
          updateSummary();
        }

        knowBtn.addEventListener("click", () => setKnown("known"));
        dkBtn.addEventListener("click", () => setKnown("unknown"));

        actions.appendChild(knowBtn);
        actions.appendChild(dkBtn);

        row.appendChild(enEl);
        row.appendChild(koEl);
        row.appendChild(actions);

        wordList.appendChild(row);
      });

      updateSummary();
    }

    function applyShowAll(show) {
      const rows = wordList.children;
      for (let i = 0; i < currentWords.length; i++) {
        const koEl = rows[i]?.children?.[1];
        if (!koEl) continue;

        revealedState[i] = show;

        if (show) {
          koEl.classList.remove("mask");
          koEl.textContent = currentWords[i].ko ?? "";
        } else {
          koEl.classList.add("mask");
          koEl.textContent = MASK;
        }
      }
    }

    function shuffleWords() {
      const shuffled = [...currentWords]
        .map(v => ({ v, r: Math.random() }))
        .sort((a, b) => a.r - b.r)
        .map(o => o.v);

      renderWords(shuffled);
      setStatus("ğŸ”€ ë‹¨ì–´ ìˆœì„œë¥¼ ì„ì—ˆì–´ìš”. (ì„ íƒ ìƒíƒœëŠ” ì´ˆê¸°í™”ë¼ìš”)", "muted");
    }

    function getSelectedSetMeta() {
      const opt = setSelect.selectedOptions?.[0];
      const setId = opt?.dataset?.setId || "";
      const setLabel = opt?.dataset?.setLabel || opt?.textContent || "";
      return { setId, setLabel };
    }

    function buildUnknownWordsText() {
      const unknown = [];
      for (let i = 0; i < currentWords.length; i++) {
        if (knowState[i] === "unknown") unknown.push(currentWords[i].en);
      }
      // í•œ ì¤„ì— í•˜ë‚˜ì”©
      return unknown.join("\n");
    }

    function buildCounts() {
      const total = currentWords.length;
      const knownCount = knowState.filter(v => v === "known").length;
      const unknownCount = knowState.filter(v => v === "unknown").length;
      return { total, knownCount, unknownCount };
    }

    function openTallySubmitPopup() {
      if (!window.Tally || typeof window.Tally.openPopup !== "function") {
        alert("Tally ë¡œë”©ì´ ì•„ì§ ì•ˆ ëì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const { total, knownCount, unknownCount } = buildCounts();
      const unknownWords = buildUnknownWordsText();
      const nowIso = new Date().toISOString();

      // âœ… hidden fields payload
      const hiddenFields = {};
      hiddenFields[TALLY_FIELDS.studentId] = currentStudentId;
      hiddenFields[TALLY_FIELDS.setId] = currentSetId;
      hiddenFields[TALLY_FIELDS.setLabel] = currentSetLabel;

      hiddenFields[TALLY_FIELDS.knownCount] = String(knownCount);
      hiddenFields[TALLY_FIELDS.unknownCount] = String(unknownCount);
      hiddenFields[TALLY_FIELDS.totalCount] = String(total);

      hiddenFields[TALLY_FIELDS.unknownWords] = unknownWords;

      hiddenFields[TALLY_FIELDS.pageUrl] = location.href;
      hiddenFields[TALLY_FIELDS.submittedAt] = nowIso;

      // âœ… íŒì—… ì—´ê¸°
      window.Tally.openPopup(TALLY_FORM_ID, {
        // Tally hidden fieldsëŠ” querystring ë°©ì‹ìœ¼ë¡œë„ ê°€ëŠ¥í•˜ì§€ë§Œ,
        // openPopup optionsì˜ hiddenFieldsë¡œ ë„£ëŠ” ê²Œ ê°€ì¥ ê¹”ë”í•¨.
        hiddenFields,
        onSubmit: () => {
          setStatus("âœ… ì „ì†¡ ì™„ë£Œ! (Tally ì œì¶œë¨)", "ok");
        }
      });
    }

    // =========================
    // Main flows
    // =========================
    async function loadStudent(studentIdRaw) {
      const id = normalizeId(studentIdRaw);
      if (!id) {
        setStatus("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "danger");
        return;
      }

      currentStudentId = id;
      localStorage.setItem(STORAGE_KEY_LAST_ID, id);

      const indexUrl = buildIndexPath(id);

      try {
        setStatus(`ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (${indexUrl.replace(location.origin, "")})`, "muted");

        const idx = await fetchJson(indexUrl);

        if (!idx || !Array.isArray(idx.sets)) {
          throw new Error("index.json í˜•ì‹ ì˜¤ë¥˜ (sets ë°°ì—´ ì—†ìŒ)");
        }
        if (idx.sets.length === 0) {
          throw new Error("ì„¸íŠ¸ê°€ 0ê°œì…ë‹ˆë‹¤. index.jsonì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        }

        currentIndex = idx;

        controls.style.display = "block";
        renderSetOptions(currentIndex.sets);

        // ì²« ì„¸íŠ¸ ìë™ ë¡œë“œ
        const firstPath = currentIndex.sets[0].path;
        await loadSetByPath(firstPath);

        setStatus(`âœ… ${id} ì„¸íŠ¸ ${currentIndex.sets.length}ê°œ ë¡œë“œë¨`, "ok");
      } catch (err) {
        console.error(err);
        controls.style.display = "none";
        wordList.innerHTML = "";
        setStatus(`âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, "danger");
      }
    }

    async function loadSetByPath(pathFromIndex) {
      try {
        const setUrl = toAbsolutePath(pathFromIndex);
        const words = await fetchJson(setUrl);

        if (!Array.isArray(words)) {
          throw new Error("ì„¸íŠ¸ JSON í˜•ì‹ ì˜¤ë¥˜ (ë°°ì—´ì´ ì•„ë‹˜)");
        }

        // ì„¸íŠ¸ ë©”íƒ€ ê°±ì‹ 
        const meta = getSelectedSetMeta();
        currentSetId = meta.setId || (pathFromIndex.match(/(\d{6})\.json$/)?.[1] ?? "");
        currentSetLabel = meta.setLabel || currentSetId || "set";

        renderWords(words);
        setStatus(`âœ… ì„¸íŠ¸ ë¡œë“œë¨: ${currentSetLabel}`, "ok");

      } catch (err) {
        console.error(err);
        wordList.innerHTML = "";
        setStatus(`âŒ ì„¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, "danger");
      }
    }

    // =========================
    // Events
    // =========================
    button.addEventListener("click", () => loadStudent(input.value));

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadStudent(input.value);
    });

    setSelect.addEventListener("change", async () => {
      const path = setSelect.value;
      await loadSetByPath(path);
    });

    showAllBtn.addEventListener("click", () => {
      applyShowAll(true);
      setStatus("ğŸ‘€ ì „ì²´ ëœ»ì„ í‘œì‹œí–ˆì–´ìš”.", "muted");
    });

    hideAllBtn.addEventListener("click", () => {
      applyShowAll(false);
      setStatus("ğŸ™ˆ ì „ì²´ ëœ»ì„ ë‹¤ì‹œ ê°€ë ¸ì–´ìš”.", "muted");
    });

    shuffleBtn.addEventListener("click", () => {
      shuffleWords();
    });

    sendBtn.addEventListener("click", () => {
      if (!currentStudentId) {
        setStatus("ë¨¼ì € í•™ìƒ IDë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.", "danger");
        return;
      }
      if (!currentWords.length) {
        setStatus("ë³´ë‚¼ ë‹¨ì–´ê°€ ì—†ì–´ìš”.", "danger");
        return;
      }
      // ë¯¸ì„ íƒì´ ìˆì–´ë„ ë³´ë‚´ê²Œ í• ì§€? (í˜„ì¬ëŠ” í—ˆìš©)
      openTallySubmitPopup();
    });

    // =========================
    // Init: last ID autofill
    // =========================
    (function init() {
      const last = localStorage.getItem(STORAGE_KEY_LAST_ID);
      if (last) {
        input.value = last;
        setStatus(`ì´ì „ ID "${last}"ê°€ ìë™ ì…ë ¥ëì–´ìš”. (ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”)`, "muted");
      } else {
        setStatus("í•™ìƒ IDë¥¼ ì…ë ¥í•˜ê³  ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.", "muted");
      }
    })();
  </script>
</body>
</html>
